{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Courtyard AI Internal Docs","text":"<p>Welcome to the internal technical documentation for the Courtyard AI platform.</p>"},{"location":"#documentation","title":"Documentation","text":"<ul> <li>Setup New Environment Guide - Complete guide for setting up a new Terraform environment from scratch</li> </ul>"},{"location":"#getting-help","title":"Getting Help","text":"<ul> <li>Internal Slack: <code>#engineering</code></li> <li>Email: engineering@thecourtyard.ai</li> </ul>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/","title":"Complete Guide: Setting Up a New Terraform Environment (tomer-env-3)","text":"<p>Purpose: Step-by-step instructions for creating a completely isolated new environment from scratch</p> <p>Estimated Time: 3-4 hours (mostly GCP console clicks + waiting for provisioning)</p> <p>Assumptions: You're setting up <code>tomer-env-3</code> with no existing environment to copy from</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#table-of-contents","title":"Table of Contents","text":"<ol> <li>Prerequisites</li> <li>Phase 1: GCP Project Setup</li> <li>Phase 2: OAuth &amp; Authentication Setup</li> <li>Phase 3: Service Accounts &amp; IAM</li> <li>Phase 4: GitHub Integration</li> <li>Phase 5: Terraform Configuration</li> <li>Phase 6: Apply Terraform</li> <li>Phase 7: Post-Deployment Setup</li> <li>Troubleshooting</li> </ol>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#prerequisites","title":"Prerequisites","text":"<p>Tools Required: - <code>gcloud</code> CLI installed and authenticated   <pre><code>gcloud auth login\ngcloud auth application-default login\n</code></pre> - Terraform &gt;= 1.3.0 (check: <code>terraform version</code>) - Git (for cloning repos) - Text editor (VS Code, nano, vim) - Access to:   - Google Cloud Console   - Microsoft Azure AD (for OAuth)   - Firebase Console   - GitHub organization   - GoDaddy or DNS provider</p> <p>Before You Start: - Have the project name ready: <code>tomer-env-3</code> - Gather all API keys and secrets (OpenAI, Gemini, HuggingFace, Firebase) - Have Microsoft OAuth credentials ready - Know the domain you'll use: <code>tomer-env-3.thecourtyard.ai</code> - Get project owner email: your organization's service account owner</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-1-gcp-project-setup","title":"Phase 1: GCP Project Setup","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-11-create-gcp-project","title":"Step 1.1: Create GCP Project","text":"<p>In Google Cloud Console:</p> <ol> <li>Go to https://console.cloud.google.com</li> <li>Click Select a Project (top left dropdown)</li> <li>Click NEW PROJECT</li> <li>Fill in:</li> <li>Project Name: <code>tomer-env-3</code></li> <li>Organization: Select your organization (if applicable)</li> <li>Click CREATE</li> </ol> <p>Wait 1-2 minutes for project creation...</p> <pre><code># Verify project was created (CLI)\ngcloud projects list | grep tomer-env-3\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-12-get-project-number","title":"Step 1.2: Get Project Number","text":"<p>You'll need this for several configurations.</p> <p>In Cloud Console: 1. Navigate to Select a Project \u2192 <code>tomer-env-3</code> 2. Go to Project Settings (gear icon, top right) 3. Copy the Project Number (looks like: <code>123456789012</code>)</p> <p>Or via CLI: <pre><code>gcloud projects describe tomer-env-3 --format='value(projectNumber)'\n# Output: 123456789012\n</code></pre></p> <p>Save this value - you'll need it soon for <code>tomer-env-3.tfvars</code></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-13-enable-required-apis","title":"Step 1.3: Enable Required APIs","text":"<p>In Cloud Console:</p> <ol> <li>Go to APIs &amp; Services \u2192 Library</li> <li>Search for and ENABLE each API:</li> <li>\u2705 Compute Engine API</li> <li>\u2705 Cloud Run API</li> <li>\u2705 Cloud SQL Admin API</li> <li>\u2705 Service Networking API</li> <li>\u2705 VPC Access API</li> <li>\u2705 Secret Manager API</li> <li>\u2705 Identity-Aware Proxy API</li> <li>\u2705 Cloud DNS API</li> <li>\u2705 Network Services API</li> <li>\u2705 Firebase Management API</li> <li>\u2705 Firebase Authentication API</li> <li>\u2705 Cloud Logging API</li> <li>\u2705 IAM API</li> <li>\u2705 Artifact Registry API</li> <li>\u2705 Cloud Build API (for Artifact Registry image building)</li> </ol> <p>Or via CLI (faster): <pre><code>gcloud services enable \\\n  compute.googleapis.com \\\n  run.googleapis.com \\\n  sqladmin.googleapis.com \\\n  servicenetworking.googleapis.com \\\n  vpcaccess.googleapis.com \\\n  secretmanager.googleapis.com \\\n  iap.googleapis.com \\\n  dns.googleapis.com \\\n  networkservices.googleapis.com \\\n  identitytoolkit.googleapis.com \\\n  firebase.googleapis.com \\\n  logging.googleapis.com \\\n  iam.googleapis.com \\\n  artifactregistry.googleapis.com \\\n  cloudbuild.googleapis.com \\\n  --project=tomer-env-3\n</code></pre></p> <p>Wait for all APIs to enable (2-3 minutes)</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-14-set-billing-account","title":"Step 1.4: Set Billing Account","text":"<p>In Cloud Console: 1. Go to Billing 2. Link the project to a billing account (required to create resources) 3. Select your organization's billing account</p> <p>If you don't have billing access, contact your GCP administrator</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-2-oauth-authentication-setup","title":"Phase 2: OAuth &amp; Authentication Setup","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-21-create-iap-identity-aware-proxy-branding","title":"Step 2.1: Create IAP (Identity-Aware Proxy) Branding","text":"<p>Important: This must be done ONCE per GCP project.</p> <p>In Cloud Console:</p> <ol> <li>Go to Security \u2192 Identity-Aware Proxy</li> <li>On the OAuth Consent Screen tab:</li> <li>Click EDIT APP</li> <li> <p>Fill in:</p> <ul> <li>App name: <code>Thecourtyard AI - tomer-env-3</code></li> <li>User support email: Your email (e.g., <code>tomer@thecourtyard.ai</code>)</li> <li>Developer contact info: Your email</li> <li>Click SAVE AND CONTINUE</li> </ul> </li> <li> <p>On Scopes tab:</p> </li> <li>Click ADD OR REMOVE SCOPES</li> <li>Add: <code>openid</code>, <code>email</code>, <code>profile</code></li> <li>Click UPDATE</li> <li> <p>Click SAVE AND CONTINUE</p> </li> <li> <p>On Test Users tab:</p> </li> <li>Add yourself as test user</li> <li>Click SAVE AND CONTINUE</li> </ol> <p>Or via CLI: <pre><code># Get the brand (after created in console)\ngcloud iap oauth-brands list --project=tomer-env-3\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-22-create-iap-oauth-client","title":"Step 2.2: Create IAP OAuth Client","text":"<p>In Cloud Console:</p> <ol> <li>Go to Security \u2192 Identity-Aware Proxy</li> <li>Go to Applications tab (top menu)</li> <li>Click CREATE OAUTH CLIENT</li> <li>Choose type: Web application</li> <li>Fill in:</li> <li>Name: <code>Terraform IAP Client</code></li> <li>Authorized JavaScript origins:<ul> <li><code>https://tomer-env-3.thecourtyard.ai</code></li> </ul> </li> <li>Authorized redirect URIs:<ul> <li><code>https://tomer-env-3.thecourtyard.ai/</code></li> <li><code>https://tomer-env-3.thecourtyard.ai/_gcp_gatekeeper/authenticate_oauth</code></li> </ul> </li> <li> <p>Click CREATE</p> </li> <li> <p>IMPORTANT: Copy and save:</p> </li> <li>Client ID</li> <li>Client Secret</li> </ol> <p>You'll need these values in <code>tomer-env-3.tfvars</code></p> <pre><code># Verify via CLI\ngcloud iap oauth-clients list \\\n  --project=tomer-env-3 \\\n  --filter=\"displayName:Terraform\" \\\n  --format=\"value(name,clientId)\"\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-23-create-microsoft-oauth-app","title":"Step 2.3: Create Microsoft OAuth App","text":"<p>In Azure Portal:</p> <ol> <li>Go to https://portal.azure.com</li> <li>Navigate to Azure Active Directory \u2192 App registrations</li> <li>Click + New registration</li> <li>Fill in:</li> <li>Name: <code>Thecourtyard AI - tomer-env-3</code></li> <li>Supported account types: Select \"Accounts in any organizational directory (Any Microsoft Entra ID tenant - Multitenant)\"</li> <li> <p>Click REGISTER</p> </li> <li> <p>On the new app page:</p> </li> <li>Copy Application (client) ID - save this</li> <li>Go to Authentication \u2192 + Add a platform</li> <li>Choose Web</li> <li>Fill in Redirect URIs:<ul> <li><code>https://tomer-env-3.thecourtyard.ai</code></li> <li><code>http://localhost:5174</code></li> <li><code>https://127.0.0.1:5174</code></li> <li><code>https://&lt;FIREBASE_PROJECT&gt;.firebaseapp.com/__/auth/handler</code></li> <li><code>https://&lt;FIREBASE_PROJECT&gt;.firebaseapp.com</code></li> </ul> </li> <li> <p>Click Configure</p> </li> <li> <p>Go to Certificates &amp; secrets \u2192 Client secrets</p> </li> <li>Click + New client secret</li> <li>Description: <code>Terraform</code></li> <li>Expires: Select <code>24 months</code></li> <li>Click Add</li> <li> <p>IMPORTANT: Copy the secret VALUE immediately (you won't see it again)</p> </li> <li> <p>Go to API permissions</p> </li> <li>Click + Add a permission</li> <li>Choose Microsoft Graph</li> <li>Select Delegated permissions</li> <li>Search for and select:<ul> <li><code>email</code></li> <li><code>profile</code></li> <li><code>User.Read</code></li> <li><code>openid</code></li> </ul> </li> <li> <p>Click Add permissions</p> </li> <li> <p>Go to Token configuration</p> </li> <li>Click + Add optional claim</li> <li>Choose ID token type</li> <li>Add claims:<ul> <li>\u2705 <code>auth_time</code></li> <li>\u2705 <code>email</code></li> <li>\u2705 <code>family_name</code></li> <li>\u2705 <code>given_name</code></li> <li>\u2705 <code>groups</code></li> <li>\u2705 <code>preferred_username</code></li> <li>\u2705 <code>upn</code></li> </ul> </li> <li>Click Add</li> </ol> <p>Save the following values: <pre><code>MICROSOFT_CLIENT_ID = &lt;Application (client) ID&gt;\nMICROSOFT_CLIENT_SECRET = &lt;Secret value&gt;\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-24-create-firebase-project","title":"Step 2.4: Create Firebase Project","text":"<p>In Firebase Console:</p> <ol> <li>Go to https://console.firebase.google.com</li> <li>Click + Create project</li> <li>Project name: <code>tomer-env-3</code></li> <li>Enable Google Analytics: (optional, uncheck if not needed)</li> <li>Click CREATE PROJECT</li> </ol> <p>Wait for Firebase to initialize (2-3 minutes)</p> <ol> <li>Once created, go to Project settings (gear icon)</li> <li>Go to Service accounts tab</li> <li>Click Generate new private key</li> <li>This downloads a JSON file: <code>tomer-env-3-firebase-adminsdk-*.json</code></li> </ol> <p>Convert Firebase key to base64: <pre><code># On macOS/Linux:\nbase64 -i tomer-env-3-firebase-adminsdk-*.json | tr -d '\\n' &gt; firebase-key-base64.txt\n\n# On Windows PowerShell:\n[Convert]::ToBase64String([System.IO.File]::ReadAllBytes(\"tomer-env-3-firebase-adminsdk-*.json\")) | Set-Content firebase-key-base64.txt\n\n# On Windows (Git Bash):\nopenssl base64 -in tomer-env-3-firebase-adminsdk-*.json | tr -d '\\n' &gt; firebase-key-base64.txt\n</code></pre></p> <p>Save the base64 output - you'll need it for <code>tomer-env-3.tfvars</code></p> <p>Also go to Firebase Authentication: 1. Authentication \u2192 Sign-in method 2. Enable providers:    - \u2705 Google    - \u2705 Microsoft</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-3-service-accounts-iam","title":"Phase 3: Service Accounts &amp; IAM","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-31-create-terraform-service-account","title":"Step 3.1: Create Terraform Service Account","text":"<p>In Cloud Console:</p> <ol> <li>Go to IAM &amp; Admin \u2192 Service Accounts</li> <li>Click + CREATE SERVICE ACCOUNT</li> <li>Fill in:</li> <li>Service account name: <code>terraform-sa</code></li> <li>Service account ID: <code>terraform-sa</code> (auto-filled)</li> <li>Description: <code>Terraform service account for infrastructure deployment</code></li> <li> <p>Click CREATE AND CONTINUE</p> </li> <li> <p>Grant roles (in \"Grant this service account access to project\"):</p> </li> <li>Click + GRANT ROLES</li> <li>Add each role:<ul> <li>\u2705 <code>Editor</code> (roles/editor)</li> <li>\u2705 <code>Service Account Admin</code> (roles/iam.serviceAccountAdmin)</li> <li>\u2705 <code>Service Account User</code> (roles/iam.serviceAccountUser)</li> <li>\u2705 <code>Service Usage Admin</code> (roles/serviceusage.serviceUsageAdmin)</li> </ul> </li> <li>Click CONTINUE</li> <li>Click DONE</li> </ol> <p>Or via CLI: <pre><code># Create service account\ngcloud iam service-accounts create terraform-sa \\\n  --description=\"Terraform service account for infrastructure deployment\" \\\n  --display-name=\"Terraform SA\" \\\n  --project=tomer-env-3\n\n# Grant roles\ngcloud projects add-iam-policy-binding tomer-env-3 \\\n  --member=\"serviceAccount:terraform-sa@tomer-env-3.iam.gserviceaccount.com\" \\\n  --role=\"roles/editor\"\n\ngcloud projects add-iam-policy-binding tomer-env-3 \\\n  --member=\"serviceAccount:terraform-sa@tomer-env-3.iam.gserviceaccount.com\" \\\n  --role=\"roles/iam.serviceAccountAdmin\"\n\ngcloud projects add-iam-policy-binding tomer-env-3 \\\n  --member=\"serviceAccount:terraform-sa@tomer-env-3.iam.gserviceaccount.com\" \\\n  --role=\"roles/iam.serviceAccountUser\"\n\ngcloud projects add-iam-policy-binding tomer-env-3 \\\n  --member=\"serviceAccount:terraform-sa@tomer-env-3.iam.gserviceaccount.com\" \\\n  --role=\"roles/serviceusage.serviceUsageAdmin\"\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-32-create-terraform-service-account-key","title":"Step 3.2: Create Terraform Service Account Key","text":"<p>This is the key you'll use for local Terraform execution.</p> <p>In Cloud Console:</p> <ol> <li>Go to IAM &amp; Admin \u2192 Service Accounts</li> <li>Click on <code>terraform-sa@tomer-env-3.iam.gserviceaccount.com</code></li> <li>Go to Keys tab</li> <li>Click + CREATE KEY</li> <li>Choose JSON</li> <li>Click CREATE</li> </ol> <p>This downloads <code>tomer-env-3-terraform-key.json</code></p> <p>Use this key to authenticate locally: <pre><code># Set up gcloud to use this key\ngcloud auth activate-service-account --key-file=tomer-env-3-terraform-key.json\n\n# Verify it works\ngcloud auth list\ngcloud projects list\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-33-grant-user-iap-permissions-optional-but-recommended","title":"Step 3.3: Grant User IAP Permissions (Optional but Recommended)","text":"<p>This allows you to impersonate the terraform SA to test/debug.</p> <p>In Cloud Console:</p> <ol> <li>Go to IAM &amp; Admin \u2192 IAM</li> <li>Click + GRANT ACCESS</li> <li>New principal: Your email (e.g., <code>tomer@thecourtyard.ai</code>)</li> <li>Roles: Select <code>Service Account Token Creator</code> (roles/iam.serviceAccountTokenCreator)</li> <li>Click SAVE</li> </ol> <p>Or via CLI: <pre><code>gcloud iam service-accounts add-iam-policy-binding \\\n  terraform-sa@tomer-env-3.iam.gserviceaccount.com \\\n  --member=\"user:tomer@thecourtyard.ai\" \\\n  --role=\"roles/iam.serviceAccountTokenCreator\" \\\n  --project=tomer-env-3\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-4-github-integration","title":"Phase 4: GitHub Integration","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-41-create-github-workload-identity-federation-pool","title":"Step 4.1: Create GitHub Workload Identity Federation Pool","text":"<p>This allows GitHub Actions to authenticate to GCP WITHOUT storing service account keys.</p> <p>In Cloud Console:</p> <ol> <li>Go to IAM &amp; Admin \u2192 Workload Identity Federation</li> <li>Click + CREATE WORKLOAD IDENTITY POOL</li> <li>Fill in:</li> <li>Pool ID: <code>github-pool</code></li> <li>Pool display name: <code>GitHub Workload Identity Pool</code></li> <li>Location: Select <code>Global</code></li> <li> <p>Click CONTINUE</p> </li> <li> <p>Configure provider:</p> </li> <li>Provider ID: <code>github-provider</code></li> <li>Provider display name: <code>GitHub OIDC Provider</code></li> <li>OpenID Connect (OIDC) provider URL: <code>https://token.actions.githubusercontent.com</code></li> <li> <p>Click CONTINUE</p> </li> <li> <p>Map Google Cloud attributes:</p> </li> <li>Click ADD MAPPING</li> <li>Google Cloud attribute: <code>google.subject</code></li> <li>OIDC attribute: <code>assertion.sub</code></li> <li>Click ADD MAPPING again</li> <li>Google Cloud attribute: <code>attribute.repository</code></li> <li>OIDC attribute: <code>assertion.repository</code></li> <li> <p>Click SAVE</p> </li> <li> <p>Configure attribute conditions (optional but recommended):</p> </li> <li>Add: <code>assertion.repository.startsWith('courtyard-ai/')</code></li> <li>This restricts access to repos in your org</li> <li>Click SAVE</li> </ol> <p>Or via CLI: <pre><code># Create pool\ngcloud iam workload-identity-pools create \"github-pool\" \\\n  --location=\"global\" \\\n  --display-name=\"GitHub Workload Identity Pool\" \\\n  --project=tomer-env-3\n\n# Create provider\ngcloud iam workload-identity-pools providers create-oidc \"github-provider\" \\\n  --location=\"global\" \\\n  --workload-identity-pool=\"github-pool\" \\\n  --display-name=\"GitHub OIDC Provider\" \\\n  --issuer-uri=\"https://token.actions.githubusercontent.com\" \\\n  --attribute-mapping=\"google.subject=assertion.sub,attribute.repository=assertion.repository\" \\\n  --attribute-condition=\"assertion.repository.startsWith('courtyard-ai/')\" \\\n  --project=tomer-env-3\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-42-create-github-deployer-service-account","title":"Step 4.2: Create GitHub Deployer Service Account","text":"<p>In Cloud Console:</p> <ol> <li>Go to IAM &amp; Admin \u2192 Service Accounts</li> <li>Click + CREATE SERVICE ACCOUNT</li> <li>Fill in:</li> <li>Service account name: <code>github-deployer</code></li> <li>Service account ID: <code>github-deployer</code> (auto-filled)</li> <li>Description: <code>Used by GitHub Actions to deploy to GCP</code></li> <li> <p>Click CREATE AND CONTINUE</p> </li> <li> <p>Grant roles:</p> </li> <li>Click + GRANT ROLES</li> <li>Add roles:<ul> <li>\u2705 <code>Cloud Run Admin</code> (roles/run.admin)</li> <li>\u2705 <code>Storage Admin</code> (roles/storage.admin)</li> <li>\u2705 <code>Artifact Registry Reader</code> (roles/artifactregistry.reader)</li> <li>\u2705 <code>Artifact Registry Writer</code> (roles/artifactregistry.writer)</li> <li>\u2705 <code>Service Account User</code> (roles/iam.serviceAccountUser)</li> </ul> </li> <li>Click CONTINUE</li> <li>Click DONE</li> </ol> <p>Or via CLI: <pre><code># Create service account\ngcloud iam service-accounts create github-deployer \\\n  --description=\"Used by GitHub Actions to deploy to GCP\" \\\n  --display-name=\"GitHub Deployer\" \\\n  --project=tomer-env-3\n\n# Grant roles\nfor role in roles/run.admin roles/storage.admin roles/artifactregistry.reader roles/artifactregistry.writer roles/iam.serviceAccountUser; do\n  gcloud projects add-iam-policy-binding tomer-env-3 \\\n    --member=\"serviceAccount:github-deployer@tomer-env-3.iam.gserviceaccount.com\" \\\n    --role=\"$role\"\ndone\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-43-grant-github-oidc-access-to-deploy-service-account","title":"Step 4.3: Grant GitHub OIDC Access to Deploy Service Account","text":"<p>This binds the GitHub OIDC provider to the deployer SA so GHA can authenticate.</p> <p>In Cloud Console:</p> <ol> <li>Go to IAM &amp; Admin \u2192 Service Accounts</li> <li>Click <code>github-deployer@tomer-env-3.iam.gserviceaccount.com</code></li> <li>Go to Permissions tab</li> <li>Click + GRANT ACCESS</li> <li> <p>New principal: (for EACH repo that will deploy)    <pre><code>principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/attribute.repository/courtyard-ai/lawgic-ai-backend\n</code></pre>    Replace <code>PROJECT_NUMBER</code> with your project number, and <code>lawgic-ai-backend</code> with your repo name</p> </li> <li> <p>Role: <code>Workload Identity User</code> (roles/iam.workloadIdentityUser)</p> </li> <li>Click SAVE</li> </ol> <p>Repeat for each GitHub repo that will deploy: - <code>courtyard-ai/lawgic-ai-backend</code> - <code>courtyard-ai/lawgic-ai-engine</code> - <code>courtyard-ai/lawgic-ai-dashboard</code></p> <p>Or via CLI: <pre><code>PROJECT_NUMBER=$(gcloud projects describe tomer-env-3 --format='value(projectNumber)')\n\n# For each repo:\ngcloud iam service-accounts add-iam-policy-binding \\\n  github-deployer@tomer-env-3.iam.gserviceaccount.com \\\n  --role=\"roles/iam.workloadIdentityUser\" \\\n  --member=\"principalSet://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/attribute.repository/courtyard-ai/lawgic-ai-backend\" \\\n  --project=tomer-env-3\n\n# Repeat for engine and dashboard repos...\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-44-get-github-wif-details-for-later-use","title":"Step 4.4: Get GitHub WIF Details (For Later Use)","text":"<p>You'll need these values for GitHub Actions workflow files.</p> <pre><code>PROJECT_NUMBER=$(gcloud projects describe tomer-env-3 --format='value(projectNumber)')\n\necho \"Service Account Email: github-deployer@tomer-env-3.iam.gserviceaccount.com\"\necho \"Workload Identity Provider: projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/providers/github-provider\"\n</code></pre> <p>Save these values - you'll need them in GitHub Actions workflows</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-5-terraform-configuration","title":"Phase 5: Terraform Configuration","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-51-prepare-environment-variables-secrets","title":"Step 5.1: Prepare Environment Variables (Secrets)","text":"<p>You'll need these values for <code>tomer-env-3.tfvars</code>. Gather:</p> <p>From GCP (already created): - \u2705 <code>project_id</code>: <code>tomer-env-3</code> - \u2705 <code>project_number</code>: (from Step 1.2) - \u2705 <code>google_iap_client_id</code>: (from Step 2.2) - \u2705 <code>google_iap_client_secret</code>: (from Step 2.2)</p> <p>From Microsoft Azure: - \u2705 <code>microsoft_client_id</code>: (from Step 2.3) - \u2705 <code>microsoft_client_secret</code>: (from Step 2.3)</p> <p>From Firebase: - \u2705 <code>firebase_service_account_key_base64</code>: (from Step 2.4)</p> <p>Generated (create secure passwords): <pre><code># Generate secure password for database\nopenssl rand -base64 32\n# Output: abc123... (save as DB_PASSWORD)\n\n# Generate secure password for admin user\nopenssl rand -base64 32\n# Output: xyz789... (save as ADMIN_PASSWORD)\n</code></pre></p> <p>From Third-party APIs (gather these separately): - \u2705 <code>openai_api_key</code>: Get from OpenAI dashboard - \u2705 <code>gemini_api_key</code>: Get from Google Cloud's Vertex AI - \u2705 <code>huggingface_api_token</code>: Get from HuggingFace account</p> <p>Organization/User Info: - \u2705 <code>workspace_user_email</code>: Your email (e.g., <code>tomer@thecourtyard.ai</code>) - \u2705 <code>admin_user_email</code>: Admin email (can be same as yours) - \u2705 <code>domain</code>: <code>tomer-env-3.thecourtyard.ai</code> (or your domain)</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-52-create-tfvars-file","title":"Step 5.2: Create tfvars File","text":"<p>Navigate to the Terraform directory:</p> <pre><code>cd c:/Users/tomer/dev2/devops/infra/terraform/gcp\n</code></pre> <p>Create <code>tomer-env-3.tfvars</code>:</p> <pre><code>cat &gt; tomer-env-3.tfvars &lt;&lt; 'EOF'\n# Project Configuration\nproject_id     = \"tomer-env-3\"\nproject_number = \"123456789012\"  # FROM STEP 1.2\nregion         = \"me-west1\"\nzone           = \"me-west1-a\"\n\n# Environment Identification\nenvironment          = \"tomer-env-3\"\nworkspace_user_email = \"tomer@thecourtyard.ai\"\n\n# Database Configuration\ndb_user     = \"courtyard\"\ndb_password = \"PASTE_DB_PASSWORD_HERE\"  # FROM STEP 5.1\ndb_name     = \"courtyard\"\n\n# Cloud Run Services\nbackend_service_name   = \"backend-api\"\nbackend_repository_id  = \"development\"\nbackend_image_id       = \"backend\"\n\nengine_service_name    = \"engine\"\nengine_repository_id   = \"development\"\nengine_image_id        = \"engine\"\n\ndashboard_service_name = \"dashboard\"\ndashboard_repository_id = \"development\"\ndashboard_image_id      = \"dashboard\"\n\n# Storage\ndashboard_bucket_name = \"tomer-env-3-dashboard-bucket\"\n\n# Domain &amp; Support\ndomain        = \"tomer-env-3.thecourtyard.ai\"\nsupport_email = \"tomer@thecourtyard.ai\"\n\n# OAuth &amp; Authentication\nmicrosoft_client_id     = \"PASTE_MICROSOFT_CLIENT_ID_HERE\"          # FROM STEP 2.3\nmicrosoft_client_secret = \"PASTE_MICROSOFT_CLIENT_SECRET_HERE\"      # FROM STEP 2.3\nadmin_user_email        = \"tomer@thecourtyard.ai\"\nadmin_user_password     = \"PASTE_ADMIN_PASSWORD_HERE\"               # FROM STEP 5.1\n\n# AI Services\nopenai_api_key           = \"PASTE_OPENAI_API_KEY_HERE\"\ngemini_api_key           = \"PASTE_GEMINI_API_KEY_HERE\"\nhuggingface_api_token    = \"PASTE_HUGGINGFACE_TOKEN_HERE\"\nfirebase_service_account_key_base64 = \"PASTE_FIREBASE_KEY_BASE64_HERE\"  # FROM STEP 2.4\n\n# Cloud Location\ngoogle_cloud_location = \"us-central1\"\nEOF\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-53-update-tfvars-with-actual-values","title":"Step 5.3: Update tfvars with Actual Values","text":"<p>Edit the file with your values:</p> <pre><code># On Windows:\nnotepad tomer-env-3.tfvars\n\n# On macOS/Linux:\nnano tomer-env-3.tfvars\n</code></pre> <p>Replace all <code>PASTE_*</code> placeholders with actual values from Step 5.1</p> <p>IMPORTANT - Secure handling: - \u274c DON'T commit tfvars with real secrets to Git - \u2705 DO store in 1Password, LastPass, or <code>.gitignore</code> - \u2705 DO use environment variables in CI/CD</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-54-create-terraform-workspace","title":"Step 5.4: Create Terraform Workspace","text":"<pre><code># List existing workspaces\nterraform workspace list\n\n# Create new workspace\nterraform workspace new tomer-env-3\n\n# Verify workspace was created\nterraform workspace list\n# Output:\n#   default\n# * tomer-env-3\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-55-initialize-terraform-backend","title":"Step 5.5: Initialize Terraform Backend","text":"<pre><code># Initialize Terraform\nterraform init\n\n# Verify initialization succeeded\nterraform validate\n# Output: Success! The configuration is valid.\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-6-apply-terraform","title":"Phase 6: Apply Terraform","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-61-plan-terraform-changes","title":"Step 6.1: Plan Terraform Changes","text":"<pre><code># Generate plan\nterraform plan -var-file=\"tomer-env-3.tfvars\" -out=tomer-env-3.tfplan\n\n# Review output - should show:\n# - Network resources (VPC, subnets)\n# - PostgreSQL database\n# - Service accounts\n# - Cloud Run services (backend, engine, dashboard)\n# - Load balancers\n# - Secret Manager secrets\n# - etc.\n\n# You should see: Plan: XXX to add, 0 to change, 0 to destroy\n</code></pre> <p>If there are errors, see Troubleshooting section</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-62-apply-terraform-configuration","title":"Step 6.2: Apply Terraform Configuration","text":"<pre><code># Apply the plan\nterraform apply tomer-env-3.tfplan\n\n# Wait for infrastructure to be created (5-10 minutes)\n# Watch the output for any errors\n</code></pre> <p>What Terraform is Creating: - VPC network with 3 subnets - PostgreSQL database instance - 3 Cloud Run services (backend, engine, dashboard) - 3 Artifact Registry repositories - Secret Manager secrets - Load balancer with SSL - Internal DNS zone - Security policies - Debug VM (optional)</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-63-verify-terraform-succeeded","title":"Step 6.3: Verify Terraform Succeeded","text":"<pre><code># Check Terraform state\nterraform state list\n# Should show all created resources\n\n# Verify resources in GCP\ngcloud compute networks list --project=tomer-env-3\ngcloud sql instances list --project=tomer-env-3\ngcloud run services list --project=tomer-env-3\ngcloud compute instances list --project=tomer-env-3\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#phase-7-post-deployment-setup","title":"Phase 7: Post-Deployment Setup","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-71-dns-configuration","title":"Step 7.1: DNS Configuration","text":"<p>You need to create DNS records for your domain to point to the load balancer IP.</p> <p>Get the Load Balancer IP:</p> <pre><code># Find the external IP\ngcloud compute addresses list --project=tomer-env-3\n\n# Or from Terraform output (if configured)\nterraform output -var-file=\"tomer-env-3.tfvars\"\n</code></pre> <p>Look for: <code>tomer-env-3-lb-ip</code> (should be a global static IP like <code>1.2.3.4</code>)</p> <p>In GoDaddy or your DNS provider:</p> <ol> <li>Go to DNS settings for <code>thecourtyard.ai</code></li> <li>Create an A record:</li> <li>Host: <code>tomer-env-3</code></li> <li>Points to: <code>1.2.3.4</code> (the load balancer IP)</li> <li>TTL: <code>3600</code> (1 hour) or auto</li> <li> <p>Click Save</p> </li> <li> <p>Verify DNS resolves:    <pre><code>nslookup tomer-env-3.thecourtyard.ai\n# Should return the load balancer IP\n</code></pre></p> </li> </ol>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-72-update-artifact-registry-repositories","title":"Step 7.2: Update Artifact Registry Repositories","text":"<p>The Terraform created 3 empty Artifact Registry repositories. You need to push initial Docker images.</p> <p>For each service (backend, engine, dashboard), update their GitHub workflow files:</p> <ol> <li>Go to the repository (e.g., <code>lawgic-ai-backend</code>)</li> <li>Go to <code>.github/workflows/deploy.yml</code></li> <li>Update the image location:    <pre><code>- name: Deploy to Cloud Run\n  uses: google-github-actions/deploy-cloudrun@v0\n  with:\n    service: tomer-env-3-backend-api\n    region: me-west1\n    image: me-west1-docker.pkg.dev/tomer-env-3/development/backend:latest\n</code></pre></li> </ol> <p>Or push initial placeholder image: <pre><code># Authenticate Docker with Artifact Registry\ngcloud auth configure-docker me-west1-docker.pkg.dev\n\n# Build and push a placeholder image\ndocker build -t me-west1-docker.pkg.dev/tomer-env-3/development/backend:latest .\ndocker push me-west1-docker.pkg.dev/tomer-env-3/development/backend:latest\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-73-create-github-actions-secrets","title":"Step 7.3: Create GitHub Actions Secrets","text":"<p>For each repository (<code>lawgic-ai-backend</code>, <code>lawgic-ai-engine</code>, <code>lawgic-ai-dashboard</code>):</p> <ol> <li>Go to Settings \u2192 Secrets and variables \u2192 Actions</li> <li>Create secrets:</li> </ol> <pre><code>GCP_PROJECT_ID = tomer-env-3\nGCP_REGION = me-west1\nGCP_WORKLOAD_IDENTITY_PROVIDER = projects/123456789012/locations/global/workloadIdentityPools/github-pool/providers/github-provider\nGCP_SERVICE_ACCOUNT = github-deployer@tomer-env-3.iam.gserviceaccount.com\n</code></pre> <p>Get these from Step 4.4</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-74-createupdate-github-workflows","title":"Step 7.4: Create/Update GitHub Workflows","text":"<p>Each repository needs a GitHub Actions workflow file to deploy to the new environment.</p> <p>Example <code>.github/workflows/deploy-tomer-env-3.yml</code>:</p> <pre><code>name: Deploy to tomer-env-3\n\non:\n  push:\n    branches: [ main ]\n\npermissions:\n  contents: read\n  id-token: write\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n\n      - name: Authenticate to Google Cloud\n        uses: google-github-actions/auth@v1\n        with:\n          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}\n          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}\n\n      - name: Set up Cloud SDK\n        uses: google-github-actions/setup-gcloud@v1\n\n      - name: Build and push Docker image\n        run: |\n          gcloud builds submit \\\n            --tag me-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/development/backend:latest \\\n            --project=${{ secrets.GCP_PROJECT_ID }}\n\n      - name: Deploy to Cloud Run\n        run: |\n          gcloud run deploy tomer-env-3-backend-api \\\n            --image me-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/development/backend:latest \\\n            --region ${{ secrets.GCP_REGION }} \\\n            --project=${{ secrets.GCP_PROJECT_ID }}\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-75-test-load-balancer-access","title":"Step 7.5: Test Load Balancer Access","text":"<pre><code># Test the external load balancer\ncurl -I https://tomer-env-3.thecourtyard.ai/health\n# Should return: HTTP/2 200 (or 403 if IP is blocked)\n\n# Test internal services\ngcloud compute instances ssh tomer-env-3-debug-vm \\\n  --zone=me-west1-a \\\n  --project=tomer-env-3 \\\n  --command=\"curl http://engine.tomer-env-3.internal:8888/health\"\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-76-verify-database-connection","title":"Step 7.6: Verify Database Connection","text":"<pre><code># SSH into debug VM\ngcloud compute instances ssh tomer-env-3-debug-vm \\\n  --zone=me-west1-a \\\n  --project=tomer-env-3\n\n# From debug VM, test database:\napt update &amp;&amp; apt install -y postgresql-client\npsql -h 10.0.0.3 -U courtyard -d courtyard -c \"SELECT version();\"\n# Enter password: (from tomer-env-3.tfvars db_password)\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#step-77-monitor-terraform-outputs","title":"Step 7.7: Monitor Terraform Outputs","text":"<pre><code># Get IAP OAuth credentials\nterraform output -json\n\n# Expected output:\n# {\n#   \"iap_oauth_client_id\": \"123...xyz.apps.googleusercontent.com\",\n#   \"iap_oauth_client_secret\": \"GOCSPX-...\"\n# }\n</code></pre>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#troubleshooting","title":"Troubleshooting","text":""},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-terraform-init-fails-with-backend-error","title":"Issue: <code>terraform init</code> fails with backend error","text":"<p>Error: <code>Error: Backend initialization required</code></p> <p>Solution: <pre><code># Check credentials\ngcloud auth list\n# Output should show: terraform-sa@tomer-env-3.iam.gserviceaccount.com (active)\n\n# If not, re-authenticate:\ngcloud auth activate-service-account --key-file=tomer-env-3-terraform-key.json\ngcloud auth application-default login\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-apis-not-enabled-error","title":"Issue: APIs not enabled error","text":"<p>Error: <code>Permission denied on service ... API</code></p> <p>Solution: <pre><code># Re-enable all required APIs\ngcloud services enable \\\n  compute.googleapis.com \\\n  run.googleapis.com \\\n  sqladmin.googleapis.com \\\n  --project=tomer-env-3\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-vpc-peering-fails-during-terraform-apply","title":"Issue: VPC Peering fails during <code>terraform apply</code>","text":"<p>Error: <code>Error: Error creating Service Networking Connection</code></p> <p>Solution: Usually resolves itself after retry: <pre><code># Wait 2 minutes, then retry\nterraform apply -var-file=\"tomer-env-3.tfvars\"\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-cloud-run-services-in-error-state","title":"Issue: Cloud Run services in <code>Error</code> state","text":"<p>Error: Pod stays in <code>Pending</code> state or Error creating service</p> <p>Check logs: <pre><code>gcloud run services describe tomer-env-3-backend-api \\\n  --region=me-west1 \\\n  --project=tomer-env-3 \\\n  --format=yaml\n</code></pre></p> <p>Common causes: - \u274c Docker image not found (Artifact Registry empty) - \u274c VPC connector not ready (wait 5 minutes) - \u274c Secrets not accessible (check IAM)</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-load-balancer-returns-403-forbidden","title":"Issue: Load balancer returns 403 Forbidden","text":"<p>Cause: IP whitelist security policy is blocking your IP</p> <p>Solution:</p> <p>Option A: Check your IP and add it to <code>main.tf</code> (lines 437, 464): <pre><code># Get your IP\ncurl ifconfig.me\n# Output: 1.2.3.4\n\n# Add to security policy in main.tf:\nsrc_ip_ranges = [\"1.2.3.4/32\", \"147.236.179.64/32\", \"...\"]\n\n# Re-apply:\nterraform apply -var-file=\"tomer-env-3.tfvars\"\n</code></pre></p> <p>Option B: Temporarily disable security policy (testing only): <pre><code># Temporarily allow all traffic\ngcloud compute security-policies rules update 2147483647 \\\n  --action allow \\\n  --project=tomer-env-3 \\\n  --security-policy=tomer-env-3-ip-whitelist-policy\n\n# Test access\n\n# Re-apply security policy:\nterraform apply -var-file=\"tomer-env-3.tfvars\"\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-database-connection-times-out","title":"Issue: Database connection times out","text":"<p>Error: <code>timeout waiting for connection from 10.0.0.3:5432</code></p> <p>Cause: VPC Access Connector not yet ready</p> <p>Solution: <pre><code># Wait 5-10 minutes for connector to initialize, then test again\n\n# Check connector status:\ngcloud compute vpc-access connectors list \\\n  --region=me-west1 \\\n  --project=tomer-env-3\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-secret-manager-values-not-found","title":"Issue: Secret Manager values not found","text":"<p>Error: <code>Error 404: Secret not found</code></p> <p>Solution: <pre><code># Verify secrets were created\ngcloud secrets list --project=tomer-env-3\n\n# Verify Cloud Run has access\ngcloud secrets get-iam-policy tomer-env-3-backend-env \\\n  --project=tomer-env-3\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#issue-dns-not-resolving","title":"Issue: DNS not resolving","text":"<p>Error: <code>Name or service not known</code> when pinging domain</p> <p>Solution: <pre><code># Verify DNS record was created\nnslookup tomer-env-3.thecourtyard.ai\n\n# If not resolving, check:\n# 1. DNS record exists in GoDaddy\n# 2. Load balancer IP is correct\n# 3. Wait 5-10 minutes for DNS propagation\n\n# Force DNS refresh:\nipconfig /flushdns  # Windows\nsudo dscacheutil -flushcache  # macOS\nsudo systemctl restart systemd-resolved  # Linux\n</code></pre></p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#next-steps-after-setup","title":"Next Steps After Setup","text":"<ol> <li>Deploy applications - Push code to GitHub, workflows deploy to Cloud Run</li> <li>Monitor resources - Set up Cloud Monitoring/Logging dashboards</li> <li>Test end-to-end - Verify all 3 services communicate</li> <li>Set up backups - Ensure database backups are scheduled</li> <li>Configure alerts - Set up alert policies for errors/high latency</li> <li>Document credentials - Store all secrets in 1Password/vault</li> <li>Team access - Grant IAM roles to team members</li> </ol>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#checklist","title":"Checklist","text":"<p>Pre-Setup: - [ ] GCP Organization access - [ ] Azure AD access (for Microsoft OAuth) - [ ] Firebase access - [ ] GitHub organization admin access - [ ] GoDaddy/DNS provider access - [ ] API keys ready (OpenAI, Gemini, HuggingFace)</p> <p>Phase 1: GCP Project - [ ] Project created (<code>tomer-env-3</code>) - [ ] Project number saved - [ ] 15 APIs enabled - [ ] Billing account linked</p> <p>Phase 2: OAuth - [ ] IAP branding created - [ ] IAP OAuth client created (ID + secret saved) - [ ] Microsoft app registered (ID + secret saved) - [ ] Firebase project created - [ ] Firebase key in base64 saved</p> <p>Phase 3: Service Accounts - [ ] <code>terraform-sa</code> created with 4 roles - [ ] <code>terraform-sa</code> key downloaded and saved - [ ] <code>github-deployer</code> created with 5 roles - [ ] User IAP permissions granted</p> <p>Phase 4: GitHub - [ ] WIF pool created (<code>github-pool</code>) - [ ] WIF provider created (<code>github-provider</code>) - [ ] <code>github-deployer</code> SA has WIF permissions - [ ] WIF details saved (service account email + provider path)</p> <p>Phase 5: Terraform - [ ] <code>tomer-env-3.tfvars</code> created with all values - [ ] <code>tomer-env-3</code> workspace created - [ ] <code>terraform init</code> succeeded - [ ] <code>terraform validate</code> passed</p> <p>Phase 6: Apply - [ ] <code>terraform plan</code> reviewed - [ ] <code>terraform apply</code> succeeded - [ ] All resources created (check <code>terraform state list</code>)</p> <p>Phase 7: Post-Deployment - [ ] DNS record created and resolving - [ ] Load balancer accessible - [ ] Artifact Registry repos ready - [ ] GitHub Actions secrets configured - [ ] GitHub workflows created - [ ] Database connectivity verified</p>"},{"location":"SETUP_NEW_ENVIRONMENT_GUIDE/#success-criteria","title":"Success Criteria","text":"<p>Your environment is ready when:</p> <p>\u2705 <code>curl https://tomer-env-3.thecourtyard.ai/health</code> returns <code>200 OK</code> \u2705 <code>terraform state list</code> shows all resources created \u2705 <code>gcloud sql instances list</code> shows PostgreSQL database \u2705 <code>gcloud run services list</code> shows 3 Cloud Run services (backend, engine, dashboard) \u2705 <code>gcloud container images list</code> shows 3 image repos (backend, engine, dashboard) \u2705 GitHub Actions can deploy to Cloud Run \u2705 Database password works and you can query the database \u2705 All 3 services can communicate via internal load balancer</p> <p>Congratulations! You now have a fully isolated <code>tomer-env-3</code> environment! \ud83c\udf89</p>"}]}